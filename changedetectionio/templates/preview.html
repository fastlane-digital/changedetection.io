{% extends 'base.html' %}

{% block content %}
    <script>
        const screenshot_url = "{{url_for('static_content', group='screenshot', filename=uuid)}}";
        const triggered_line_numbers = {{ triggered_line_numbers|tojson }};
        {% if last_error_screenshot %}
            const error_screenshot_url = "{{url_for('static_content', group='screenshot', filename=uuid, error_screenshot=1) }}";
        {% endif %}
        const highlight_submit_ignore_url = "{{url_for('ui.ui_edit.highlight_submit_ignore_url', uuid=uuid)}}";
    </script>
    <script src="{{url_for('static_content', group='js', filename='plugins.js')}}"></script>
    <script src="{{ url_for('static_content', group='js', filename='diff-overview.js') }}" defer></script>
    <script src="{{ url_for('static_content', group='js', filename='preview.js') }}" defer></script>
    <script src="{{ url_for('static_content', group='js', filename='tabs.js') }}" defer></script>

    {% if versions|length >= 2 %}
        <div id="settings" class="p-4 bg-base-200 rounded-box shadow mb-6 text-center">
            <form action="" method="POST" class="inline-flex flex-wrap items-center gap-2">
                <label for="preview-version" class="label-text mr-2">Select timestamp:</label>
                <select id="preview-version" name="from_version" class="select select-bordered select-sm needs-localtime">
                    {% for version in versions|reverse %}
                        <option value="{{ version }}" {% if version == current_version %}selected{% endif %}>
                            {{ version }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary btn-sm">Go</button>
            </form>
            <div class="mt-2">
                <strong class="mr-2">Keyboard:</strong>
                <a href="#" class="btn btn-primary btn-sm" id="btn-previous">&larr; Previous</a>
                <a class="btn btn-primary btn-sm" id="btn-next" href="#">&rarr; Next</a>
            </div>
        </div>
    {% endif %}

    <div role="tablist" class="tabs tabs-lifted tabs-sm">
        {% if last_error_text %}
            <a role="tab" class="tab" id="error-text-tab-link" href="#error-text">Error Text</a>
        {% endif %}
        {% if last_error_screenshot %}
            <a role="tab" class="tab" id="error-screenshot-tab-link" href="#error-screenshot">Error Screenshot</a>
        {% endif %}
        {% if history_n > 0 %}
            <a role="tab" class="tab {% if not last_error_text and not last_error_screenshot %}tab-active{% endif %}" id="text-tab-link" href="#text">Text</a>
            <a role="tab" class="tab" id="screenshot-tab-link" href="#screenshot">Screenshot</a>
        {% endif %}
    </div>

    <div id="diff-ui" class="bg-base-100 p-4 rounded-box shadow mt-0 border border-base-300 border-t-0">
        <div class="tab-pane-inner" id="error-text">
            <div class="snapshot-age error text-xs text-error-content mb-2 p-2 bg-error/20 rounded-md inline-block">{{ watch.error_text_ctime|format_seconds_ago }} seconds ago</div>
            <pre class="whitespace-pre-wrap break-all p-4 bg-base-200 rounded-box text-sm">{{ last_error_text }}</pre>
        </div>

        <div class="tab-pane-inner" id="error-screenshot">
            <div class="snapshot-age error text-xs text-error-content mb-2 p-2 bg-error/20 rounded-md inline-block">{{ watch.snapshot_error_screenshot_ctime|format_seconds_ago }} seconds ago</div>
            <img id="error-screenshot-img" class="max-w-full h-auto rounded-lg border border-base-300 shadow-md"
                 alt="Current erroring screenshot from most recent request">
        </div>

        <div class="tab-pane-inner" id="text">
            <div class="snapshot-age text-xs text-base-content/70 mb-2 p-2 bg-base-200 rounded-md inline-block">{{ current_version|format_timestamp_timeago }}</div>
            <div role="alert" class="alert alert-info text-sm my-2"><strong>Pro-tip</strong>: Highlight text to add to ignore filters</div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <tbody>
                    <tr>
                        <td id="diff-col" class="highlightable-filter">
                            <pre class="whitespace-pre-wrap break-all p-4 bg-base-100 rounded-box text-sm border-l-2 border-base-300">{{ content }}</pre>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane-inner" id="screenshot">
            <div role="alert" class="alert alert-info text-sm my-2">
                For now, Differences are performed on text, not graphically, only the latest screenshot is available.
            </div>
            {% if is_html_webdriver %}
                {% if screenshot %}
                    <div class="snapshot-age text-xs text-base-content/70 mb-2 p-2 bg-base-200 rounded-md inline-block">{{ watch.snapshot_screenshot_ctime|format_timestamp_timeago }}</div>
                    <img id="screenshot-img" class="max-w-full h-auto rounded-lg border border-base-300 shadow-md" alt="Current screenshot from most recent request">
                {% else %}
                    <p class="text-center py-8">No screenshot available just yet! Try rechecking the page.</p>
                {% endif %}
            {% else %}
                <p class="text-center py-8 font-semibold">Screenshot requires Playwright/WebDriver enabled</p>
            {% endif %}
        </div>
    </div>
{% endblock %}
