{% extends 'base.html' %}
{% from '_helpers.html' import render_field, render_checkbox_field, render_button %}
{% block content %}
<script>
    const screenshot_url="{{url_for('static_content', group='screenshot', filename=uuid)}}";
    {% if last_error_screenshot %}
    const error_screenshot_url="{{url_for('static_content', group='screenshot', filename=uuid, error_screenshot=1) }}";
    {% endif %}

    const highlight_submit_ignore_url="{{url_for('ui.ui_edit.highlight_submit_ignore_url', uuid=uuid)}}";

</script>
<script src="{{url_for('static_content', group='js', filename='diff-overview.js')}}" defer></script>

<div id="settings" class="p-4 md:p-6 bg-base-200 rounded-box shadow mb-6">
    <form action="" method="GET" id="diff-form" class="space-y-4">
        <div class="flex flex-wrap items-center gap-4">
            {% if versions|length >= 1 %}
            <div class="form-control">
                <label class="label"><span class="label-text font-semibold">Compare versions:</span></label>
                <div class="flex items-center gap-2">
                    <span class="text-sm">From:</span>
                    <select id="diff-version" name="from_version" class="select select-sm select-bordered needs-localtime">
                        {% for version in versions|reverse %}
                            <option value="{{ version }}" {% if version== from_version %} selected {% endif %}>
                                {{ version }}
                            </option>
                        {% endfor %}
                    </select>
                    <span class="text-sm">To:</span>
                    <select id="current-version" name="to_version" class="select select-sm select-bordered needs-localtime">
                        {% for version in versions|reverse %}
                            <option value="{{ version }}" {% if version== to_version %} selected {% endif %}>
                                {{ version }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">Go</button>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="flex flex-wrap items-center gap-4">
            <div class="form-control">
                 <label class="label"><span class="label-text font-semibold">Diff style:</span></label>
                 <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                    <label class="label cursor-pointer gap-1">
                        <input type="radio" name="diff_type" value="diffWords" class="radio radio-sm" />
                        <span class="label-text text-sm">Words</span>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <input type="radio" name="diff_type" value="diffLines" class="radio radio-sm" checked />
                        <span class="label-text text-sm">Lines</span>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <input type="radio" name="diff_type" value="diffChars" class="radio radio-sm" />
                        <span class="label-text text-sm">Chars</span>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <input type="radio" name="diff_type" value="diffJson" class="radio radio-sm" />
                        <span class="label-text text-sm">JSON</span>
                    </label>
                 </div>
            </div>
            <div class="form-control">
                <label class="label cursor-pointer gap-1" id="label-diff-ignorewhitespace">
                    <input type="checkbox" id="ignoreWhitespace" name="ignoreWhitespace" class="checkbox checkbox-sm" />
                    <span class="label-text text-sm">Ignore Whitespace</span>
                </label>
            </div>
        </div>
    </form>
</div>

<div id="diff-jump" class="my-2 text-right">
    <a id="jump-next-diff" title="Jump to next difference" class="btn btn-sm btn-outline">Jump to next difference &darr;</a>
</div>

<script src="{{url_for('static_content', group='js', filename='tabs.js')}}" defer></script>
{# DaisyUI Tabs #}
<div role="tablist" class="tabs tabs-lifted tabs-lg mb-1">
    {% if last_error_text %}
        <input type="radio" name="diff_tabs" role="tab" class="tab" id="error-text-tab-radio" aria-label="Error Text" {% if last_error_text and not last_error_screenshot %}checked{% endif %} />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="error-text">
            <div class="badge badge-error badge-outline mb-2">{{watch_a.error_text_ctime|format_seconds_ago}} seconds ago</div>
    {% endif %}
    {% if last_error_screenshot %}
        <input type="radio" name="diff_tabs" role="tab" class="tab" id="error-screenshot-tab-radio" aria-label="Error Screenshot" {% if last_error_screenshot and not last_error_text %}checked{% endif %}/>
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="error-screenshot">
            <div class="badge badge-error badge-outline mb-2">{{watch_a.snapshot_error_screenshot_ctime|format_seconds_ago}} seconds ago</div>
    {% endif %}

    <input type="radio" name="diff_tabs" role="tab" class="tab" id="text-tab-radio" aria-label="Text" {% if not last_error_text and not last_error_screenshot %}checked{% endif %}/>
    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="text">
        {# Content for Text tab will be handled in the next diff block #}
    </div>

    <input type="radio" name="diff_tabs" role="tab" class="tab" id="screenshot-tab-radio" aria-label="Screenshot" />
    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="screenshot">
        {# Content for Screenshot tab will be handled in the next diff block #}
    </div>

    <input type="radio" name="diff_tabs" role="tab" class="tab" id="extract-tab-radio" aria-label="Extract Data" />
    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="extract">
        {# Content for Extract Data tab will be handled in the next diff block #}
    </div>
</div>


<div id="diff-ui"> {# This div might become redundant as content is moved into DaisyUI tab panels above #}
    {# Content for Error Text tab (already placed in its DaisyUI tabpanel) #}
    {% if last_error_text %}
        <pre class="bg-base-300 p-4 rounded-box text-sm whitespace-pre-wrap">{{ last_error_text }}</pre>
        {# The initial div with snapshot age is already inside the tab panel #}
    {% endif %}

    {# Content for Error Screenshot tab (already placed in its DaisyUI tabpanel) #}
    {% if last_error_screenshot %}
        <img id="error-screenshot-img" style="max-width: 80%;" class="rounded-box shadow-md mx-auto" alt="Current error-ing screenshot from most recent request" >
        {# The initial div with snapshot age is already inside the tab panel #}
    {% endif %}
</div>

{# Adjusting the main tab content structure to inject directly into the tab panels defined earlier #}
<script>
    function initDiffPage() {
        // Text Diff Tab Content
        const textTabContent = `
            {% if password_enabled_and_share_is_off %}
            <div class="alert alert-info text-sm mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>Pro-tip: You can enable <strong>"share access when password is enabled"</strong> from settings.</span>
            </div>
            {% endif %}
            <div class="badge badge-outline mb-2">{{watch_a.snapshot_text_ctime|format_timestamp_timeago}}</div>
            <div>
                <div id="a" style="display: none;">{{from_version_file_contents}}</div>
                <div id="b" style="display: none;">{{to_version_file_contents}}</div>
                <div id="diff-col" class="text-sm">
                    <span id="result" class="highlightable-filter whitespace-pre-wrap"></span>
                </div>
            </div>
            <p class="text-xs mt-4">Diff algorithm from the amazing <a href="https://github.com/kpdecker/jsdiff" class="link link-hover">github.com/kpdecker/jsdiff</a></p>
        `;
        if (document.getElementById('text')) document.getElementById('text').innerHTML = textTabContent;

        // Screenshot Tab Content
        const screenshotTabContent = `
            <div class="alert alert-info text-sm mb-4">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>For now, Differences are performed on text, not graphically, only the latest screenshot is available.</span>
            </div>
            {% if is_html_webdriver %}
                {% if screenshot %}
                <div class="badge badge-outline mb-2">{{watch_a.snapshot_screenshot_ctime|format_timestamp_timeago}}</div>
                <img style="max-width: 80%;" id="screenshot-img" class="rounded-box shadow-md mx-auto" alt="Current screenshot from most recent request" >
                {% else %}
                <p class="text-center font-semibold">No screenshot available just yet! Try rechecking the page.</p>
                {% endif %}
            {% else %}
            <p class="text-center font-semibold"><strong>Screenshot requires Playwright/WebDriver enabled</strong></p>
            {% endif %}
        `;
        if (document.getElementById('screenshot')) document.getElementById('screenshot').innerHTML = screenshotTabContent;

        // Extract Data Tab Content
        const extractTabContent = `
            <form id="extract-data-form" action="{{ url_for('ui.ui_views.diff_history_page', uuid=uuid) }}#extract" method="POST" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <p class="text-sm">This tool will extract text data from all of the watch history.</p>
                <div class="form-control">
                    {{ render_field(extract_form.extract_regex, class="textarea textarea-bordered w-full text-sm", rows="3", label_class="label-text") }}
                    <div class="text-xs text-base-content text-opacity-70 mt-1 space-y-1">
                        <p>A <strong>RegEx</strong> is a pattern that identifies exactly which part inside of the text that you want to extract.</p>
                        <p>For example, to extract only the numbers from text &ndash;<br>
                           <strong>Raw text</strong>: <code>Temperature <span class="text-error">5.5</span>°C in Sydney</code><br>
                           <strong>RegEx to extract:</strong> <code>Temperature <span class="text-error">([0-9\\.]+)</span></code>
                        </p>
                        <p><a href="https://RegExr.com/" target="_blank" class="link link-hover">Be sure to test your RegEx here.</a></p>
                        <p>Each RegEx group bracket <code>()</code> will be in its own column, the first column value is always the date.</p>
                    </div>
                </div>
                <div class="form-control">
                    {{ render_button(extract_form.extract_submit_button, class="btn btn-primary") }}
                </div>
            </form>
        `;
        if (document.getElementById('extract')) document.getElementById('extract').innerHTML = extractTabContent;
        
        // Trigger image loading for screenshots if tab is active or becomes active
        // This is a simplified approach; real implementation might need MutationObserver or tab change events
        if (document.getElementById('error-screenshot-img') && error_screenshot_url) {
            document.getElementById('error-screenshot-img').src = error_screenshot_url;
        }
        if (document.getElementById('screenshot-img') && screenshot_url) {
             document.getElementById('screenshot-img').src = screenshot_url;
        }
    }

    // Ensure this runs after the DOM is fully loaded and DaisyUI tabs are potentially initialized by tabs.js
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDiffPage);
    } else {
        initDiffPage();
    }
</script>

<script>
    const newest_version_timestamp = {{newest_version_timestamp}};
</script>
<script src="{{url_for('static_content', group='js', filename='diff.min.js')}}"></script>

<script src="{{url_for('static_content', group='js', filename='diff-render.js')}}"></script>


{% endblock %}
