{% extends 'base.html' %}

{% block content %}
{% from '_helpers.html' import render_field, render_checkbox_field, render_button, render_time_schedule_form %}
{% from '_common_fields.html' import render_common_settings_form %}
<script>
    const notification_base_url="{{url_for('ui.ui_notification.ajax_callback_send_notification_test', mode="global-settings")}}";
{% if emailprefix %}
    const email_notification_prefix=JSON.parse('{{emailprefix|tojson}}');
{% endif %}
</script>
<script src="{{url_for('static_content', group='js', filename='tabs.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='plugins.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='notifications.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='vis.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='global-settings.js')}}" defer></script>
<script src="{{url_for('static_content', group='js', filename='scheduler.js')}}" defer></script>

<div class="edit-form p-4 md:p-6">
    {# DaisyUI Tabs #}
    <div role="tablist" class="tabs tabs-lifted tabs-lg mb-6">
        <input type="radio" name="settings_tabs" role="tab" class="tab" id="general-tab-radio" aria-label="General" checked />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="general">
            {# Content for General tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="notifications-tab-radio" aria-label="Notifications" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="notifications">
            {# Content for Notifications tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="fetching-tab-radio" aria-label="Fetching" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="fetching">
            {# Content for Fetching tab will be here #}
        </div>
        
        <input type="radio" name="settings_tabs" role="tab" class="tab" id="filters-tab-radio" aria-label="Global Filters" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="filters">
            {# Content for Filters tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="ui-options-tab-radio" aria-label="UI Options" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="ui-options">
            {# Content for UI Options tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="api-tab-radio" aria-label="API" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="api">
            {# Content for API tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="timedate-tab-radio" aria-label="Time & Date" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="timedate">
            {# Content for Time & Date tab will be here #}
        </div>

        <input type="radio" name="settings_tabs" role="tab" class="tab" id="proxies-tab-radio" aria-label="CAPTCHA & Proxies" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6" id="proxies">
            {# Content for Proxies tab will be here #}
        </div>
    </div>

    <div class="box-wrap inner"> {# This div might be redundant if tab panels handle their own background/padding #}
        <form action="{{url_for('settings.settings_page')}}" method="POST" class="settings">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >
            
            {# General Tab Content - Moved into the tab panel #}
            <script>
                function moveGeneralContent() {
                    const generalContent = `
                        <fieldset class="space-y-4">
                            <div class="form-control">
                                {{ render_field(form.requests.form.time_between_check, class="input input-bordered input-sm w-full md:w-auto time-check-widget", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Default recheck time for all watches, current system minimum is <i>${min_system_recheck_seconds}</i> seconds (<a href="https://github.com/dgtlmoon/changedetection.io/wiki/Misc-system-settings#enviroment-variables" class="link link-hover">more info</a>).</span>
                                <div id="time-between-check-schedule" class="mt-2 p-3 border rounded-md bg-base-200">
                                    <h4 class="text-sm font-semibold mb-2">Default Schedule (optional)</h4>
                                    {{ render_time_schedule_form(form.requests, available_timezones, timezone_default_config) }}
                                </div>
                            </div>
                            <div class="form-control">
                                {{ render_field(form.requests.form.jitter_seconds, class="input input-bordered input-sm w-full md:w-auto jitter_seconds", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Example - 3 seconds random jitter could trigger up to 3 seconds earlier or up to 3 seconds later.</span>
                            </div>
                            <div class="form-control">
                                {{ render_field(form.application.form.filter_failure_notification_threshold_attempts, class="input input-bordered input-sm w-full md:w-auto filter_failure_notification_threshold_attempts", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">After this many consecutive times that the CSS/xPath filter is missing, send a notification. Set to <strong>0</strong> to disable.</span>
                            </div>
                            <div class="form-control">
                                {% if not hide_remove_pass %}
                                    {% if current_user.is_authenticated %}
                                        {{ render_button(form.application.form.removepassword_button, class="btn btn-warning btn-sm") }}
                                    {% else %}
                                        {{ render_field(form.application.form.password, class="input input-bordered input-sm w-full md:w-auto", label_class="label-text") }}
                                        <span class="text-xs text-base-content text-opacity-70 mt-1">Password protection for your changedetection.io application.</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-sm text-base-content text-opacity-70">Password is locked.</span>
                                {% endif %}
                            </div>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.shared_diff_access, class="checkbox checkbox-sm shared_diff_access", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Allow access to view watch diff page when password is enabled (Good for sharing the diff page).</span>
                            </div>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.rss_hide_muted_watches, class="checkbox checkbox-sm", label_class="label-text") }}
                            </div>
                            <div class="form-control">
                                {{ render_field(form.application.form.pager_size, class="input input-bordered input-sm w-full md:w-auto", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Number of items per page in the watch overview list, 0 to disable.</span>
                            </div>
                            <div class="form-control">
                                {{ render_field(form.application.form.rss_content_format, class="select select-bordered select-sm w-full md:w-auto", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Love RSS? Does your reader support HTML? Set it here.</span>
                            </div>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.extract_title_as_title, class="checkbox checkbox-sm", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Note: This will automatically apply to all existing watches.</span>
                            </div>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.empty_pages_are_a_change, class="checkbox checkbox-sm", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">When a request returns no content, or the HTML does not contain any text, is this considered a change?</span>
                            </div>
                            {% if form.requests.proxy %}
                            <div class="form-control">
                                {{ render_field(form.requests.form.proxy, class="select select-bordered select-sm w-full md:w-auto fetch-backend-proxy", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Choose a default proxy for all watches.</span>
                            </div>
                            {% endif %}
                        </fieldset>
                    `;
                    const generalTabContainer = document.getElementById('general');
                    if (generalTabContainer) generalTabContainer.innerHTML = generalContent;
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', moveGeneralContent);
                } else {
                    moveGeneralContent();
                }
            </script>
            
            <script>
                function moveRemainingSettingsTabsContent() {
                    // Notifications Tab
                    const notificationsContent = `
                        <fieldset class="space-y-4">
                            <div class="field-group space-y-3">
                                {{ render_common_settings_form(form.application.form, emailprefix, settings_application, extra_notification_token_placeholder_info) }}
                            </div>
                            <div class="form-control" id="notification-base-url">
                                {{ render_field(form.application.form.base_url, class="input input-bordered input-sm w-full", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">
                                    Base URL used for the <code>{{ '{{ base_url }}' }}</code> token in notification links.<br>
                                    Default value is the system environment variable '<code>BASE_URL</code>' - <a href="https://github.com/dgtlmoon/changedetection.io/wiki/Configurable-BASE_URL-setting" class="link link-hover">read more here</a>.
                                </span>
                            </div>
                        </fieldset>
                    `;
                    const notificationsTabContainer = document.getElementById('notifications');
                    if (notificationsTabContainer) notificationsTabContainer.innerHTML = notificationsContent;

                    // Fetching Tab
                    const fetchingContent = `
                        <fieldset class="space-y-4">
                            <div class="form-control">
                                {{ render_field(form.application.form.fetch_backend, class="radio fetch-backend", label_class="label-text") }} {# Assuming radio #}
                                <div class="text-xs text-base-content text-opacity-70 mt-1 space-y-1">
                                    <p>Use the <strong>Basic</strong> method (default) where your watched site doesn't need Javascript to render.</p>
                                    <p>The <strong>Chrome/Javascript</strong> method requires a network connection to a running WebDriver+Chrome server, set by the ENV var 'WEBDRIVER_URL'. </p>
                                </div>
                            </div>
                            <fieldset class="form-control p-4 border border-base-300 rounded-md space-y-2" id="webdriver-override-options" data-visible-for="application-fetch_backend=html_webdriver">
                                <legend class="text-sm font-semibold">WebDriver Default Options</legend>
                                <div class="text-xs text-base-content text-opacity-70">
                                    <strong>If you're having trouble waiting for the page to be fully rendered (text missing etc), try increasing the 'wait' time here.</strong>
                                    This will wait <i>n</i> seconds before extracting the text.
                                </div>
                                <div class="form-control">
                                    {{ render_field(form.application.form.webdriver_delay, class="input input-bordered input-sm w-full md:w-auto", label_class="label-text text-sm") }}
                                </div>
                            </fieldset>
                            <div class="form-control">
                                {{ render_field(form.requests.form.default_ua, class="select select-bordered select-sm w-full", label_class="label-text") }}
                                <div class="text-xs text-base-content text-opacity-70 mt-1 space-y-1">
                                   <p>Applied to all requests.</p>
                                   <p>Note: Simply changing the User-Agent often does not defeat anti-robot technologies, it's important to consider <a href="https://changedetection.io/tutorial/what-are-main-types-anti-robot-mechanisms" class="link link-hover">all of the ways that the browser is detected</a>.</p>
                                </div>
                            </div>
                            <div class="text-sm mt-3">
                                Tip: <a href="https://github.com/dgtlmoon/changedetection.io/wiki/Proxy-configuration#brightdata-proxy-support" class="link link-hover">Connect using Bright Data and Oxylabs Proxies, find out more here.</a>
                            </div>
                        </fieldset>
                    `;
                    const fetchingTabContainer = document.getElementById('fetching');
                    if (fetchingTabContainer) fetchingTabContainer.innerHTML = fetchingContent;

                    // Filters Tab
                    const filtersContent = `
                        <fieldset class="space-y-4">
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.ignore_whitespace, class="checkbox checkbox-sm", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1 block">Ignore whitespace, tabs and new-lines/line-feeds when considering if a change was detected.<br>
                                <i>Note:</i> Changing this will change the status of your existing watches, possibly trigger alerts etc.</span>
                            </div>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.render_anchor_tag_content, class="checkbox checkbox-sm", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1 block">Render anchor tag content, default disabled, when enabled renders links as <code>(link text)[https://somesite.com]</code><br>
                                <i>Note:</i> Changing this could affect the content of your existing watches, possibly trigger alerts etc.</span>
                            </div>
                            <div class="form-control">
                              {{ render_field(form.application.form.global_subtractive_selectors, class="textarea textarea-bordered text-sm w-full", rows=5, placeholder="header\nfooter\nnav\n.stockticker\n//*[contains(text(), 'Advertisement')]", label_class="label-text") }}
                              <div class="text-xs text-base-content text-opacity-70 mt-1">
                                <ul class="list-disc list-inside ml-2">
                                  <li>Remove HTML element(s) by CSS and XPath selectors before text conversion.</li>
                                  <li>Don't paste HTML here, use only CSS and XPath selectors.</li>
                                  <li>Add multiple elements, CSS or XPath selectors per line to ignore multiple parts of the HTML.</li>
                                </ul>
                              </div>
                            </div>
                            <div class="form-control">
                                {{ render_field(form.application.form.global_ignore_text, class="textarea textarea-bordered text-sm w-full", rows=5, placeholder="Some text to ignore in a line\n/some.regex\\d{2}/ for case-INsensitive regex", label_class="label-text") }}
                                <div class="text-xs text-base-content text-opacity-70 mt-1">
                                    <p>Note: This is applied globally in addition to the per-watch rules.</p>
                                    <ul class="list-disc list-inside ml-2">
                                        <li>Matching text will be <strong>ignored</strong> in the text snapshot (you can still see it but it wont trigger a change).</li>
                                        <li>Note: This is applied globally in addition to the per-watch rules.</li>
                                        <li>Each line processed separately, any line matching will be ignored (removed before creating the checksum).</li>
                                        <li>Regular Expression support, wrap the entire line in forward slash <code>/regex/</code>.</li>
                                        <li>Changing this will affect the comparison checksum which may trigger an alert.</li>
                                    </ul>
                                 </div>
                            </div>
                        </fieldset>
                    `;
                    const filtersTabContainer = document.getElementById('filters');
                    if (filtersTabContainer) filtersTabContainer.innerHTML = filtersContent;

                    // UI Options Tab
                    const uiOptionsContent = `
                        <fieldset class="space-y-4">
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.ui.form.open_diff_in_new_tab, class="checkbox checkbox-sm open_diff_in_new_tab", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">Enable this setting to open the diff page in a new tab. If disabled, the diff page will open in the current tab.</span>
                            </div>
                        </fieldset>
                    `;
                    const uiOptionsTabContainer = document.getElementById('ui-options');
                    if (uiOptionsTabContainer) uiOptionsTabContainer.innerHTML = uiOptionsContent;
                    
                    // API Tab
                    const apiContent = `
                        <fieldset class="space-y-4">
                            <h4 class="text-lg font-semibold">API Access</h4>
                            <p class="text-sm">Drive your changedetection.io via API, More about <a href="https://github.com/dgtlmoon/changedetection.io/wiki/API-Reference" class="link link-hover">API access here</a>.</p>
                            <div class="form-control">
                                {{ render_checkbox_field(form.application.form.api_access_token_enabled, class="checkbox checkbox-sm", label_class="label-text") }}
                                <div class="text-xs text-base-content text-opacity-70 mt-1">Restrict API access limit by using <code>x-api-key</code> header - required for the Chrome Extension to work.</div>
                                <div class="text-sm mt-2">API Key: <kbd class="kbd kbd-sm" id="api-key">${api_key}</kbd>
                                    <button type="button" class="btn btn-xs btn-ghost" id="api-key-copy-btn" onclick="navigator.clipboard.writeText('${api_key}')">Copy</button>
                                </div>
                            </div>
                            <div class="form-control">
                                <a href="{{url_for('settings.settings_reset_api_key')}}" class="btn btn-sm btn-outline btn-warning w-max">Regenerate API key</a>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold">Chrome Extension</h4>
                                <p class="text-sm">Easily add any web-page to your changedetection.io installation from within Chrome.</p>
                                <p class="text-sm"><strong>Step 1</strong> Install the extension, <strong>Step 2</strong> Navigate to this page, <strong>Step 3</strong> Open the extension from the toolbar and click "<i>Sync API Access</i>".</p>
                                <p>
                                    <a id="chrome-extension-link" title="Try our new Chrome Extension!" href="https://chromewebstore.google.com/detail/changedetectionio-website/kefcfmgmlhmankjmnbijimhofdjekbop" class="btn btn-outline btn-sm">
                                        <img alt="Chrome store icon" src="{{ url_for('static_content', group='images', filename='google-chrome-icon.png') }}" class="h-4 w-4 mr-2"> Chrome Webstore
                                    </a>
                                </p>
                            </div>
                        </fieldset>
                    `;
                    const apiTabContainer = document.getElementById('api');
                    if (apiTabContainer) apiTabContainer.innerHTML = apiContent;

                    // Time & Date Tab
                    const timedateContent = `
                        <fieldset class="space-y-4">
                            <div class="text-sm">Ensure the settings below are correct, they are used to manage the time schedule for checking your web page watches.</div>
                            <div class="text-sm">
                                <p><strong>UTC Time &amp Date from Server:</strong> <span id="utc-time" class="font-mono">${utc_time}</span></p>
                                <p><strong>Local Time &amp Date in Browser:</strong> <span class="local-time font-mono" data-utc="${utc_time}"></span></p>
                            </div>
                            <div class="form-control">
                               {{ render_field(form.application.form.timezone, class="select select-bordered select-sm w-full md:w-auto", label_class="label-text", list="timezones_list") }}
                                <datalist id="timezones_list">
                                    {% for tz_name in available_timezones %}
                                        <option value="{{ tz_name }}">{{ tz_name }}</option>
                                    {% endfor %}
                                </datalist>
                            </div>
                        </fieldset>
                    `;
                    const timedateTabContainer = document.getElementById('timedate');
                    if (timedateTabContainer) timedateTabContainer.innerHTML = timedateContent;
                    
                    // Proxies Tab
                    const proxiesContent = `
                        <fieldset class="space-y-6">
                            <div id="recommended-proxy" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 border rounded-lg bg-base-200 space-y-2">
                                    <img style="height: 2em;" src="{{url_for('static_content', group='images', filename='brightdata.svg')}}" alt="BrightData Proxy Provider">
                                    <p class="text-sm">BrightData offer world-class proxy services, "Data Center" proxies are a very affordable way to proxy your requests, whilst <strong><a href="https://brightdata.grsm.io/n0r16zf7eivq" class="link">WebUnlocker</a></strong> can help solve most CAPTCHAs.</p>
                                    <p class="text-xs">BrightData offer many <a href="https://brightdata.com/proxy-types" target="new" class="link">many different types of proxies</a>, it is worth reading about what is best for your use-case.</p>
                                    <p class="text-xs">When you have <a href="https://brightdata.grsm.io/n0r16zf7eivq" class="link">registered</a>, enabled the required services, visit the <a href="https://brightdata.com/cp/api_example?" class="link">API example page</a>, then select <strong>Python</strong>, set the country you wish to use, then copy+paste the access Proxy URL into the "Extra Proxies" boxes below.</p>
                                    <p class="text-xs">The Proxy URL with BrightData should start with <code>http://brd-customer...</code></p>
                                    <p class="text-xs">When you sign up using <a href="https://brightdata.grsm.io/n0r16zf7eivq" class="link">https://brightdata.grsm.io/n0r16zf7eivq</a> BrightData will match any first deposit up to $150.</p>
                                </div>
                                <div class="p-4 border rounded-lg bg-base-200 space-y-2">
                                    <img style="height: 2em;" src="{{url_for('static_content', group='images', filename='oxylabs.svg')}}" alt="Oxylabs Proxy Provider">
                                    <p class="text-sm">Collect public data at scale with industry-leading web scraping solutions and the world’s largest ethical proxy network.</p>
                                    <p class="text-xs">Oxylabs also provide a <a href="https://oxylabs.io/products/web-unblocker" class="link"><strong>WebUnlocker</strong></a> proxy that bypasses sophisticated anti-bot systems, so you don’t have to.</p>
                                    <p class="text-xs">Serve over <a href="https://oxylabs.io/location-proxy" class="link">195 countries</a>, providing <a href="https://oxylabs.io/products/residential-proxy-pool" class="link">Residential</a>, <a href="https://oxylabs.io/products/mobile-proxies" class="link">Mobile</a> and <a href="https://oxylabs.io/products/rotating-isp-proxies" class="link">ISP proxies</a> and much more.</p>
                                    <p class="text-xs">Use the promo code <strong>boost35</strong> with this link <a href="https://oxylabs.go2cloud.org/SH2d" class="link">https://oxylabs.go2cloud.org/SH2d</a> for 35% off Residential, Mobile proxies, Web Unblocker, and Scraper APIs.</p>
                                </div>
                            </div>
                            <p class="text-sm"><strong>Tip</strong>: "Residential" and "Mobile" proxy type can be more successfull than "Data Center" for blocked websites.</p>
                            <div class="form-control" id="extra-proxies-setting">
                                {{ render_field(form.requests.form.extra_proxies, class="textarea textarea-bordered text-sm w-full", rows="4", label_class="label-text") }}
                                <span class="text-xs text-base-content text-opacity-70 mt-1">"Name" will be used for selecting the proxy in the Watch Edit settings.</span><br>
                                <span class="text-xs text-base-content text-opacity-70">SOCKS5 proxies with authentication are only supported with 'plain requests' fetcher, for other fetchers you should whitelist the IP access instead.</span>
                            </div>
                            <div class="form-control" id="extra-browsers-setting">
                                <p class="text-sm mb-1"><i>Extra Browsers</i> can be attached to further defeat CAPTCHA's on websites that are particularly hard to scrape. <a href="https://changedetection.io/tutorial/using-bright-datas-scraping-browser-pass-captchas-and-other-protection-when-monitoring" class="link">More instructions and examples here</a>.</p>
                                {{ render_field(form.requests.form.extra_browsers, class="textarea textarea-bordered text-sm w-full", rows="3", label_class="label-text") }}
                            </div>
                        </fieldset>
                    `;
                    const proxiesTabContainer = document.getElementById('proxies');
                    if (proxiesTabContainer) proxiesTabContainer.innerHTML = proxiesContent;

                    // Final Actions - this should be outside the tab content, but within the form
                    const actionsContent = `
                        <div class="mt-8 pt-6 border-t border-base-300 flex flex-wrap gap-2">
                            {{ render_button(form.save_button, class="btn btn-primary") }}
                            <a href="{{url_for('watchlist.index')}}" class="btn btn-ghost">Back</a>
                            <a href="{{url_for('ui.clear_all_history')}}" class="btn btn-error btn-outline">Clear Snapshot History</a>
                        </div>
                    `;
                    // Assuming there's a placeholder div for actions or appending to the form
                    const formElement = document.querySelector('.settings'); // The main form
                    if (formElement) {
                         const actionsDiv = document.createElement('div');
                         actionsDiv.innerHTML = actionsContent;
                         formElement.appendChild(actionsDiv);
                    }
                     // Re-initialize any JS that depends on these new elements, e.g., for time/date localization
                    if (typeof vis !== 'undefined' && vis.bind_clock) { vis.bind_clock(); }
                    if (typeof globalSettings !== 'undefined' && globalSettings.init) { globalSettings.init(); }

                } // End of moveRemainingSettingsTabsContent

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', moveRemainingSettingsTabsContent);
                } else {
                    moveRemainingSettingsTabsContent();
                }
            </script>
            {# Removed original tab-pane-inner divs as their content is now injected by JS #}
        </form>
    </div>
</div>

{% endblock %}
