{% extends 'base.html' %}
{% block content %}
{% from '_helpers.html' import render_simple_field, render_field, render_nolabel_field, sort_by_title, render_button %}
<script src="{{url_for('static_content', group='js', filename='jquery-3.6.0.min.js')}}"></script>
<script src="{{url_for('static_content', group='js', filename='watch-overview.js')}}" defer></script>
<script>let nowtimeserver={{ now_time_server }};</script>

<style>
/* Keep this for the checking_now animation if not easily replicable with Tailwind */
.checking-now .last-checked {
    background-image: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.05) 40%, rgba(0,0,0,0.1) 100%);
    background-size: 0 100%;
    background-repeat: no-repeat;
    transition: background-size 0.9s ease
}
</style>
<div class="max-w-full p-4 sm:p-6 lg:p-8 mx-auto">

    <form action="{{ url_for('ui.ui_views.form_quick_watch_add', tag=active_tag_uuid) }}" method="POST" id="new-watch-form" class="mb-8 p-4 bg-base-200 rounded-box shadow-lg">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >
        <fieldset class="space-y-3">
            <legend class="text-lg font-semibold mb-2">Add a new change detection watch</legend>
            <div id="watch-add-wrapper-zone" class="flex flex-col sm:flex-row items-stretch gap-2">
                {{ render_nolabel_field(form.url, placeholder="https://...", required=True, span_class="flex-grow", class="input input-bordered input-sm sm:input-md w-full") }}
                {{ render_nolabel_field(form.tags, value=active_tag.title if active_tag_uuid else '', placeholder="watch label / tag", span_class="flex-grow", class="input input-bordered input-sm sm:input-md w-full") }}
                {{ render_button(form.watch_submit_button, text="Watch this URL!", class="btn btn-sm sm:btn-md btn-primary") }}
                {{ render_button(form.edit_and_watch_submit_button, text="Edit first then Watch", class="btn btn-sm sm:btn-md btn-outline") }}
            </div>
            <div id="quick-watch-processor-type" class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                {# Assuming render_simple_field is updated to handle radio buttons correctly with DaisyUI classes #}
                {{ render_simple_field(form.processor) }}
            </div>
        </fieldset>
        <p class="text-xs text-base-content/70 mt-2"><img alt="Create a shareable link" class="h-4 w-4 inline-block mr-1 align-text-bottom" src="{{url_for('static_content', group='images', filename='spread-white.svg')}}" > Tip: You can also add 'shared' watches. <a href="https://github.com/dgtlmoon/changedetection.io/wiki/Sharing-a-Watch" class="link link-hover">More info</a></p>
    </form>

    <form action="{{ url_for('ui.form_watch_list_checkbox_operations') }}" method="POST" id="watch-list-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >
    <input type="hidden" id="op_extradata" name="op_extradata" value="" >
    <div id="checkbox-operations" class="flex flex-wrap gap-2 mb-4 p-3 bg-base-200 rounded-lg shadow items-center">
        <button class="btn btn-xs" name="op" value="pause">Pause</button>
        <button class="btn btn-xs" name="op" value="unpause">UnPause</button>
        <button class="btn btn-xs" name="op" value="mute">Mute</button>
        <button class="btn btn-xs" name="op" value="unmute">UnMute</button>
        <button class="btn btn-xs" name="op" value="recheck">Recheck</button>
        <button class="btn btn-xs" name="op" value="assign-tag" id="checkbox-assign-tag">Tag</button>
        <button class="btn btn-xs" name="op" value="mark-viewed">Mark viewed</button>
        <button class="btn btn-xs" name="op" value="notification-default">Use default notification</button>
        <button class="btn btn-xs" name="op" value="clear-errors">Clear errors</button>
        <button class="btn btn-xs btn-error btn-outline" name="op" value="clear-history">Clear/reset history</button>
        <button class="btn btn-xs btn-error btn-outline" name="op" value="delete">Delete</button>
    </div>

    {% if watches|length >= pagination.per_page %}
        <p class="text-sm text-base-content/80 my-3">{{ pagination.info }}</p>
    {% endif %}
    {% if search_q %}<div role="alert" class="alert alert-info my-4 text-sm p-3">Searching "<strong><i>{{search_q}}</i></strong>"</div>{% endif %}
    
    <div class="flex flex-wrap gap-2 my-4">
        <a href="{{url_for('watchlist.index')}}" class="btn btn-sm {{'btn-primary' if not active_tag_uuid else 'btn-outline'}}">All</a>
        {% for uuid, tag in tags %}
            {% if tag != "" %}
                <a href="{{url_for('watchlist.index', tag=uuid) }}" class="btn btn-sm {{'btn-primary' if active_tag_uuid == uuid else 'btn-outline'}}">{{ tag.title }}</a>
            {% endif %}
        {% endfor %}
    </div>

    {% set sort_order = sort_order or 'asc' %}
    {% set sort_attribute = sort_attribute or 'last_changed'  %}
    {% set pagination_page = request.args.get('page', 0) %}
    {% set cols_required = 6 %}
    {% set any_has_restock_price_processor = datastore.any_watches_have_processor_by_name("restock_diff") %}
    {% if any_has_restock_price_processor %}
        {% set cols_required = cols_required + 1 %}
    {% endif %}

    <div id="watch-table-wrapper" class="overflow-x-auto shadow-md rounded-lg">
        <table class="table table-zebra table-sm w-full">
            <thead>
            <tr class="bg-base-200">
                {% set link_order = "desc" if sort_order  == 'asc' else "asc" %}
                <th class="p-2 sm:p-3"><label><input type="checkbox" id="check-all" class="checkbox checkbox-xs sm:checkbox-sm align-middle mr-1 sm:mr-2" > <a class="link link-hover text-inherit {{ 'font-bold text-primary' if sort_attribute == 'date_created' else '' }}"  href="{{url_for('watchlist.index', sort='date_created', order=link_order, tag=active_tag_uuid)}}"># <span class='arrow {{link_order}}'></span></a></label></th>
                <th class="p-2 sm:p-3"></th>
                <th class="p-2 sm:p-3"><a class="link link-hover text-inherit {{ 'font-bold text-primary' if sort_attribute == 'label' else '' }}" href="{{url_for('watchlist.index', sort='label', order=link_order, tag=active_tag_uuid)}}">Website <span class='arrow {{link_order}}'></span></a></th>
             {% if any_has_restock_price_processor %}
                <th class="p-2 sm:p-3">Restock &amp; Price</th>
             {% endif %}
                <th class="p-2 sm:p-3"><a class="link link-hover text-inherit {{ 'font-bold text-primary' if sort_attribute == 'last_checked' else '' }}" href="{{url_for('watchlist.index', sort='last_checked', order=link_order, tag=active_tag_uuid)}}"><span class="hidden sm:inline">Last</span> Checked <span class='arrow {{link_order}}'></span></a></th>
                <th class="p-2 sm:p-3"><a class="link link-hover text-inherit {{ 'font-bold text-primary' if sort_attribute == 'last_changed' else '' }}" href="{{url_for('watchlist.index', sort='last_changed', order=link_order, tag=active_tag_uuid)}}"><span class="hidden sm:inline">Last</span> Changed <span class='arrow {{link_order}}'></span></a></th>
                <th class="p-2 sm:p-3">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% if not watches|length %}
            <tr>
                <td colspan="{{ cols_required }}" class="p-4 text-center">No website watches configured, please add a URL in the box above, or <a href="{{ url_for('imports.import_page')}}" class="link link-hover">import a list</a>.</td>
            </tr>
            {% endif %}
            {% for watch in (watches|sort(attribute=sort_attribute, reverse=sort_order == 'asc'))|pagination_slice(skip=pagination.skip) %}
                {% set is_unviewed = watch.newest_history_key| int > watch.last_viewed and watch.history_n>=2 %}
                {% set checking_now = is_checking_now(watch) %}
            <tr id="{{ watch.uuid }}" class="processor-{{ watch['processor'] }}
                {% if watch.last_error is defined and watch.last_error != False %}bg-error/10 hover:bg-error/20{% endif %}
                {% if watch.last_notification_error is defined and watch.last_notification_error != False and not (watch.last_error is defined and watch.last_error != False) %}bg-orange-500/10 hover:bg-orange-500/20{% endif %} {# Different color for notification error if no fetch error #}
                {% if watch.paused is defined and watch.paused != False %}opacity-60 hover:opacity-100{% endif %}
                {% if is_unviewed %}font-semibold bg-base-content/5 hover:bg-base-content/10{% endif %}
                {% if watch.uuid in queued_uuids %}bg-sky-500/10 hover:bg-sky-500/20{% endif %}
                {% if checking_now %}bg-blue-500/10 hover:bg-blue-500/20 animate-pulse{% endif %}
                {% if watch.has_restock_info %} has-restock-info {% if watch['restock']['in_stock'] %}in-stock{% else %}not-in-stock{% endif %} {% else %}no-restock-info{% endif %}"
                >
                <td class="p-2 sm:p-3 checkbox-uuid"><label><input name="uuids" type="checkbox" value="{{ watch.uuid}} " class="checkbox checkbox-xs sm:checkbox-sm align-middle mr-1 sm:mr-2"> <span class="align-middle">{{ loop.index+pagination.skip }}</span></label></td>
                <td class="p-1 sm:p-2 watch-controls">
                    <div class="flex items-center gap-0.5">
                    {% if not watch.paused %}
                    <button class="btn btn-ghost btn-xs p-1 state-off" formaction="{{url_for('watchlist.index', op='pause', uuid=watch.uuid, tag=active_tag_uuid)}}" title="Pause checks"><img src="{{url_for('static_content', group='images', filename='pause.svg')}}" alt="Pause checks" class="h-4 w-4 align-middle icon icon-pause" ></button>
                    {% else %}
                    <button class="btn btn-ghost btn-xs p-1 state-on" formaction="{{url_for('watchlist.index', op='pause', uuid=watch.uuid, tag=active_tag_uuid)}}" title="UnPause checks"><img src="{{url_for('static_content', group='images', filename='play.svg')}}" alt="UnPause checks" class="h-4 w-4 align-middle icon icon-unpause" ></button>
                    {% endif %}
                    {% set mute_label = 'UnMute notification' if watch.notification_muted else 'Mute notification' %}
                    <button class="btn btn-ghost btn-xs p-1 link-mute state-{{'on' if watch.notification_muted else 'off'}}" formaction="{{url_for('watchlist.index', op='mute', uuid=watch.uuid, tag=active_tag_uuid)}}" title="{{ mute_label }}"><img src="{{url_for('static_content', group='images', filename='bell-off.svg')}}" alt="{{ mute_label }}" class="h-4 w-4 align-middle icon icon-mute" ></button>
                    </div>
                </td>
                <td class="p-2 sm:p-3 title-col break-all">
                    <a class="link link-hover text-base-content font-medium" href="{{ url_for('ui.ui_edit.edit_page', uuid=watch.uuid, tag=active_tag_uuid)}}#general">{{watch.title if watch.title is not none and watch.title|length > 0 else watch.url}}</a>
                    <a class="inline-block ml-1 h-3 w-3 text-gray-400 hover:text-primary external_link_icon" target="_blank" rel="noopener" href="{{ watch.link.replace('source:','') }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                    </a>
                    <a class="link-spread" href="{{url_for('ui.form_share_put_watch', uuid=watch.uuid)}}"><img src="{{url_for('static_content', group='images', filename='spread.svg')}}" class="status-icon icon icon-spread h-4 w-4 inline-block ml-1 text-gray-400 hover:text-primary" title="Create a link to share watch config with others" ></a>

                    {% if watch.get_fetch_backend == "html_webdriver" or (watch.get_fetch_backend == "system" and system_default_fetcher == 'html_webdriver') or "extra_browser_" in watch.get_fetch_backend %}
                    <img class="status-icon h-4 w-4 inline-block ml-1 align-middle" src="{{url_for('static_content', group='images', filename='google-chrome-icon.png')}}" alt="Using a Chrome browser" title="Using a Chrome browser" >
                    {% endif %}
                    {%if watch.is_pdf  %}<img class="status-icon h-4 w-4 inline-block ml-1 align-middle" src="{{url_for('static_content', group='images', filename='pdf-icon.svg')}}" title="Converting PDF to text" >{% endif %}
                    {% if watch.has_browser_steps %}<img class="status-icon status-browsersteps h-4 w-4 inline-block ml-1 align-middle" src="{{url_for('static_content', group='images', filename='steps.svg')}}" title="Browser Steps is enabled" >{% endif %}
                    
                    {% if watch.last_error is defined and watch.last_error != False %}
                    <div class="text-error text-xs mt-1 break-words">{{ watch.last_error }}
                        {% if '403' in watch.last_error %}
                            {% if has_proxies %}<a href="{{ url_for('settings.settings_page', uuid=watch.uuid) }}#proxies" class="link link-hover">Try other proxies/location</a>&nbsp;{% endif %}
                            <a href="{{ url_for('settings.settings_page', uuid=watch.uuid) }}#proxies" class="link link-hover">Try adding external proxies/locations</a>
                        {% endif %}
                        {% if 'empty result or contain only an image' in watch.last_error %}<a href="https://github.com/dgtlmoon/changedetection.io/wiki/Detecting-changes-in-images" class="link link-hover">more help here</a>.{% endif %}
                    </div>
                    {% endif %}
                    {% if watch.last_notification_error is defined and watch.last_notification_error != False %}
                    <div class="text-orange-500 text-xs mt-1 break-words"><a href="{{url_for('settings.notification_logs')}}" class="link link-hover">{{ watch.last_notification_error }}</a></div>
                    {% endif %}

                    {% if watch['processor'] == 'text_json_diff' and watch['has_ldjson_price_data'] and not watch['track_ldjson_price_data'] %}
                    <div role="alert" class="alert alert-sm p-2 my-1 text-xs">Switch to Restock & Price watch mode? <a href="{{url_for('price_data_follower.accept', uuid=watch.uuid)}}" class="btn btn-xs btn-success">Yes</a> <a href="{{url_for('price_data_follower.reject', uuid=watch.uuid)}}" class="btn btn-xs btn-ghost">No</a></div>
                    {% endif %}
                    {% if watch['processor'] == 'restock_diff' %}
                    <span class="tracking-ldjson-price-data badge badge-sm badge-info gap-1" title="Automatically following embedded price information"><img src="{{url_for('static_content', group='images', filename='price-tag-icon.svg')}}" class="h-3 w-3" > Price</span>
                    {% endif %}
                    {% for watch_tag_uuid, watch_tag in datastore.get_all_tags_for_watch(watch['uuid']).items() %}
                      <span class="badge badge-outline badge-xs ml-1 align-middle">{{ watch_tag.title }}</span>
                    {% endfor %}
                </td>
            {% if any_has_restock_price_processor %}
                <td class="p-2 sm:p-3 restock-and-price text-xs sm:text-sm">
                    {% if watch['processor'] == 'restock_diff'  %}
                        {% if watch.has_restock_info %}
                            <span class="badge badge-sm {{'badge-success' if watch['restock']['in_stock'] else 'badge-warning' }}" title="Detecting restock and price">
                                 {% if watch['restock']['in_stock'] %} In stock {% else %} Not in stock {% endif %}
                            </span>
                        {% endif %}
                        {% if watch.get('restock') and watch['restock']['price'] != None %}
                            <span class="badge badge-sm badge-info mt-1" title="Price">
                            {{ watch['restock']['price']|format_number_locale }} {{ watch['restock']['currency'] }}
                            </span>
                        {% elif not watch.has_restock_info and not watch.has_error %} {# Only show 'No info' if there isn't already an error message #}
                            <span class="badge badge-sm badge-error">No information</span>
                        {% endif %}
                    {% endif %}
                </td>
            {% endif %}
                <td class="p-2 sm:p-3 last-checked text-xs sm:text-sm" data-timestamp="{{ watch.last_checked }}" {% if checking_now %} data-fetchduration={{ watch.fetch_time }} data-eta_complete="{{ watch.last_checked+watch.fetch_time }}" {% endif %} >
                    {% if checking_now %}
                        <span class="loading loading-spinner loading-xs"></span><span class="ml-1"> Checking now</span>
                    {% else %}
                        {{watch|format_last_checked_time|safe}}
                    {% endif %}
                </td>
                <td class="p-2 sm:p-3 last-changed text-xs sm:text-sm" data-timestamp="{{ watch.last_changed }}">
                    {% if watch.history_n >=2 and watch.last_changed >0 %}
                        {{watch.last_changed|format_timestamp_timeago}}
                    {% else %}
                        Not yet
                    {% endif %}
                </td>
                <td class="p-1 sm:p-2 whitespace-nowrap">
                    <div class="flex flex-col sm:flex-row gap-1">
                    <a {% if watch.uuid in queued_uuids %}disabled="disabled"{% endif %} href="{{ url_for('ui.form_watch_checknow', uuid=watch.uuid, tag=request.args.get('tag')) }}"
                       class="btn btn-xs btn-outline recheck">{% if watch.uuid in queued_uuids %}Queued{% else %}Recheck{% endif %}</a>
                    <a href="{{ url_for('ui.ui_edit.edit_page', uuid=watch.uuid, tag=active_tag_uuid)}}#general" class="btn btn-xs btn-outline">Edit</a>
                    {% if watch.history_n >= 2 %}
                        {% set open_diff_in_new_tab = datastore.data['settings']['application']['ui'].get('open_diff_in_new_tab') %}
                        {% set target_attr = ' target="' ~ watch.uuid ~ '"' if open_diff_in_new_tab else '' %}
                        {%  if is_unviewed %}
                           <a href="{{ url_for('ui.ui_views.diff_history_page', uuid=watch.uuid, from_version=watch.get_from_version_based_on_last_viewed) }}" {{target_attr|safe}} class="btn btn-xs btn-primary diff-link">History</a>
                        {% else %}
                           <a href="{{ url_for('ui.ui_views.diff_history_page', uuid=watch.uuid)}}" {{target_attr|safe}} class="btn btn-xs btn-outline diff-link">History</a>
                        {% endif %}
                    {% else %}
                        {% if watch.history_n == 1 or (watch.history_n ==0 and watch.error_text_ctime )%}
                            <a href="{{ url_for('ui.ui_views.preview_page', uuid=watch.uuid)}}" {{target_attr|safe}} class="btn btn-xs btn-outline">Preview</a>
                        {% endif %}
                    {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="flex flex-wrap gap-x-4 gap-y-2 my-4 justify-end items-center" id="post-list-buttons-wrapper">
        {% if errored_count %}
            <a href="{{url_for('watchlist.index', with_errors=1, tag=request.args.get('tag')) }}" class="btn btn-sm btn-error btn-outline normal-case">With errors ({{ errored_count }})</a>
        {% endif %}
        {% if has_unviewed %}
            <a href="{{url_for('ui.mark_all_viewed',with_errors=request.args.get('with_errors',0)) }}" class="btn btn-sm normal-case">Mark all viewed</a>
        {% endif %}
        <a href="{{ url_for('ui.form_watch_checknow', tag=active_tag_uuid, with_errors=request.args.get('with_errors',0)) }}" class="btn btn-sm normal-case">Recheck all {% if active_tag_uuid %} in "{{active_tag.title}}"{%endif%}</a>
        <a href="{{ url_for('rss.feed', tag=active_tag_uuid, token=app_rss_token)}}" class="btn btn-ghost btn-sm p-1"><img alt="RSS Feed" id="feed-icon" src="{{url_for('static_content', group='images', filename='generic_feed-icon.svg')}}" class="h-5 w-5"></a>
    </div>
    {% if pagination.links %}
    <div class="join my-4">
        {{ pagination.links|replace("class=\"pure-button\"", "class=\"join-item btn btn-sm\"")|replace("class=\"pure-button pure-button-primary\"", "class=\"join-item btn btn-sm btn-primary btn-active\"")|safe }}
    </div>
    {% endif %}
    </form>
</div>
{% endblock %}
